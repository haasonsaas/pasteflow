<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Pasteflow</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;500;600;700&family=Space+Grotesk:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
      @keyframes fadeIn {
        from { opacity: 0; transform: translateY(-8px); }
        to { opacity: 1; transform: translateY(0); }
      }
      @keyframes slideIn {
        from { opacity: 0; transform: translateX(-12px); }
        to { opacity: 1; transform: translateX(0); }
      }
      @keyframes pulse {
        0%, 100% { opacity: 0.4; }
        50% { opacity: 0.8; }
      }
      @keyframes scanline {
        0% { transform: translateY(-100%); }
        100% { transform: translateY(100vh); }
      }
      @keyframes glowPulse {
        0%, 100% { box-shadow: 0 0 20px rgba(0, 255, 200, 0.15), inset 0 1px 0 rgba(255,255,255,0.05); }
        50% { box-shadow: 0 0 30px rgba(0, 255, 200, 0.25), inset 0 1px 0 rgba(255,255,255,0.05); }
      }

      :root {
        --bg-deep: #0a0b0d;
        --bg-base: #111214;
        --bg-elevated: #181a1e;
        --bg-surface: #1e2024;
        --bg-hover: #252830;

        --border-subtle: rgba(255, 255, 255, 0.06);
        --border-default: rgba(255, 255, 255, 0.1);
        --border-strong: rgba(255, 255, 255, 0.15);

        --text-primary: #e8eaed;
        --text-secondary: #9aa0a6;
        --text-tertiary: #5f6368;
        --text-disabled: #3c4043;

        --accent-primary: #00ffc8;
        --accent-secondary: #00d4a8;
        --accent-glow: rgba(0, 255, 200, 0.15);
        --accent-surface: rgba(0, 255, 200, 0.08);

        --warning: #ffb74d;
        --error: #f44336;
        --error-surface: rgba(244, 67, 54, 0.1);

        --radius-sm: 4px;
        --radius-md: 6px;
        --radius-lg: 8px;
      }

      * {
        box-sizing: border-box;
        -webkit-font-smoothing: antialiased;
      }

      body {
        margin: 0;
        font-family: "JetBrains Mono", "SF Mono", "Menlo", monospace;
        background: var(--bg-deep);
        color: var(--text-primary);
        position: relative;
        overflow-x: hidden;
      }

      /* Atmospheric background effects */
      body::before {
        content: '';
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background:
          radial-gradient(ellipse 80% 50% at 50% 0%, rgba(0, 255, 200, 0.03) 0%, transparent 50%),
          radial-gradient(ellipse 60% 40% at 100% 100%, rgba(0, 150, 255, 0.02) 0%, transparent 50%);
        pointer-events: none;
        z-index: 0;
      }

      /* Subtle noise texture */
      body::after {
        content: '';
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 256 256' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noise'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.9' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noise)'/%3E%3C/svg%3E");
        opacity: 0.015;
        pointer-events: none;
        z-index: 0;
      }

      header {
        position: relative;
        z-index: 1;
        padding: 16px 20px 12px;
        border-bottom: 1px solid var(--border-subtle);
        background: linear-gradient(180deg, var(--bg-base) 0%, var(--bg-deep) 100%);
        display: flex;
        flex-direction: column;
        gap: 12px;
      }

      .header-row {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 16px;
      }

      #suggestions {
        display: flex;
        gap: 6px;
        flex-wrap: wrap;
        animation: fadeIn 0.3s ease-out;
      }

      .rule-button {
        border: 1px solid var(--border-default);
        background: var(--bg-surface);
        padding: 6px 12px;
        border-radius: var(--radius-sm);
        cursor: pointer;
        font-size: 11px;
        font-family: inherit;
        color: var(--text-secondary);
        transition: all 0.15s ease;
        display: flex;
        align-items: center;
        gap: 6px;
        text-transform: uppercase;
        letter-spacing: 0.05em;
        font-weight: 500;
      }

      .rule-button:hover {
        background: var(--bg-hover);
        border-color: var(--border-strong);
        color: var(--text-primary);
      }

      .rule-button.active {
        background: var(--accent-surface);
        border-color: var(--accent-primary);
        color: var(--accent-primary);
        box-shadow: 0 0 20px var(--accent-glow), inset 0 1px 0 rgba(0, 255, 200, 0.1);
      }

      .rule-badges {
        display: inline-flex;
        gap: 3px;
      }

      .rule-badge {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        width: 14px;
        height: 14px;
        border-radius: 2px;
        border: 1px solid var(--border-subtle);
        font-size: 8px;
        font-weight: 700;
        color: var(--text-tertiary);
        background: var(--bg-elevated);
      }

      .rule-button.active .rule-badge {
        border-color: var(--accent-primary);
        color: var(--accent-primary);
        background: transparent;
      }

      .search-wrap {
        display: flex;
        align-items: center;
        gap: 8px;
      }

      #ruleSearch {
        border: 1px solid var(--border-default);
        border-radius: var(--radius-sm);
        padding: 8px 12px;
        font-size: 12px;
        font-family: inherit;
        background: var(--bg-surface);
        color: var(--text-primary);
        min-width: 240px;
        transition: all 0.15s ease;
      }

      #ruleSearch::placeholder {
        color: var(--text-tertiary);
      }

      #ruleSearch:focus {
        outline: none;
        border-color: var(--accent-primary);
        box-shadow: 0 0 0 3px var(--accent-glow);
      }

      #configToggle {
        border: 1px solid var(--border-default);
        background: var(--bg-surface);
        border-radius: var(--radius-sm);
        padding: 8px 14px;
        font-size: 11px;
        font-family: inherit;
        color: var(--text-secondary);
        cursor: pointer;
        transition: all 0.15s ease;
        text-transform: uppercase;
        letter-spacing: 0.05em;
        font-weight: 500;
      }

      #configToggle:hover {
        background: var(--bg-hover);
        color: var(--text-primary);
        border-color: var(--border-strong);
      }

      #configToggle.active {
        background: var(--accent-surface);
        border-color: var(--accent-primary);
        color: var(--accent-primary);
      }

      #badges {
        display: flex;
        gap: 8px;
        flex-wrap: wrap;
      }

      .badge {
        border: 1px solid var(--border-subtle);
        background: var(--bg-elevated);
        border-radius: var(--radius-sm);
        padding: 4px 10px;
        font-size: 10px;
        color: var(--text-tertiary);
        text-transform: uppercase;
        letter-spacing: 0.08em;
        font-weight: 500;
      }

      #metrics {
        font-size: 10px;
        color: var(--text-tertiary);
        font-family: inherit;
        letter-spacing: 0.02em;
      }

      #meta {
        display: flex;
        align-items: center;
        gap: 16px;
        font-size: 11px;
        color: var(--text-tertiary);
      }

      #meta label {
        display: flex;
        align-items: center;
        gap: 6px;
        cursor: pointer;
        transition: color 0.15s ease;
      }

      #meta label:hover {
        color: var(--text-secondary);
      }

      #meta input[type="checkbox"] {
        appearance: none;
        width: 14px;
        height: 14px;
        border: 1px solid var(--border-default);
        border-radius: 2px;
        background: var(--bg-surface);
        cursor: pointer;
        transition: all 0.15s ease;
        position: relative;
      }

      #meta input[type="checkbox"]:checked {
        background: var(--accent-primary);
        border-color: var(--accent-primary);
      }

      #meta input[type="checkbox"]:checked::after {
        content: '';
        position: absolute;
        left: 4px;
        top: 1px;
        width: 4px;
        height: 8px;
        border: solid var(--bg-deep);
        border-width: 0 2px 2px 0;
        transform: rotate(45deg);
      }

      #remote-badge {
        background: rgba(255, 183, 77, 0.1);
        color: var(--warning);
        padding: 3px 10px;
        border-radius: var(--radius-sm);
        font-weight: 600;
        font-size: 10px;
        text-transform: uppercase;
        letter-spacing: 0.05em;
        border: 1px solid rgba(255, 183, 77, 0.3);
      }

      #errorBanner {
        margin: 12px 20px 0;
        padding: 10px 14px;
        border-radius: var(--radius-md);
        border: 1px solid rgba(244, 67, 54, 0.3);
        background: var(--error-surface);
        color: var(--error);
        font-size: 11px;
        display: none;
        animation: fadeIn 0.2s ease-out;
      }

      main {
        position: relative;
        z-index: 1;
        padding: 16px 20px;
        display: grid;
        grid-template-columns: 1fr 1fr 260px;
        gap: 12px;
        animation: fadeIn 0.3s ease-out 0.1s both;
      }

      .pane {
        background: var(--bg-base);
        border: 1px solid var(--border-subtle);
        border-radius: var(--radius-md);
        padding: 14px;
        min-height: 180px;
        display: flex;
        flex-direction: column;
        position: relative;
        overflow: hidden;
        transition: all 0.2s ease;
      }

      .pane::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 1px;
        background: linear-gradient(90deg, transparent, rgba(255,255,255,0.05), transparent);
      }

      .pane.active {
        border-color: var(--accent-primary);
        animation: glowPulse 2s ease-in-out infinite;
      }

      .pane h3 {
        margin: 0 0 12px 0;
        font-size: 9px;
        text-transform: uppercase;
        letter-spacing: 0.15em;
        color: var(--text-tertiary);
        font-weight: 600;
        display: flex;
        align-items: center;
        gap: 8px;
      }

      .pane h3::before {
        content: '';
        width: 6px;
        height: 6px;
        background: var(--accent-primary);
        border-radius: 1px;
        opacity: 0.6;
      }

      .pane.active h3::before {
        opacity: 1;
        box-shadow: 0 0 8px var(--accent-primary);
      }

      pre {
        margin: 0;
        white-space: pre-wrap;
        word-break: break-word;
        font-family: inherit;
        font-size: 11px;
        line-height: 1.6;
        color: var(--text-secondary);
        flex: 1;
        overflow: auto;
      }

      .empty {
        color: var(--text-disabled);
        font-style: italic;
      }

      .empty-state {
        font-size: 11px;
        color: var(--text-disabled);
        padding: 8px 0;
      }

      #diff {
        grid-column: 1 / -1;
      }

      #diffText {
        color: var(--text-secondary);
      }

      #ruleInfo,
      #recentPanel {
        grid-column: 3;
      }

      #ruleInfo .rule-name {
        font-weight: 600;
        font-size: 13px;
        margin-bottom: 8px;
        color: var(--text-primary);
      }

      #ruleInfo .rule-line {
        font-size: 10px;
        color: var(--text-tertiary);
        margin-bottom: 6px;
        line-height: 1.5;
      }

      #ruleInfo .rule-controls {
        margin: 8px 0 10px;
        font-size: 11px;
        color: var(--text-tertiary);
      }

      #ruleInfo .rule-controls label {
        display: flex;
        align-items: center;
        gap: 6px;
        cursor: pointer;
      }

      #ruleInfo .rule-controls input[type="checkbox"] {
        appearance: none;
        width: 14px;
        height: 14px;
        border: 1px solid var(--border-default);
        border-radius: 2px;
        background: var(--bg-surface);
        cursor: pointer;
        transition: all 0.15s ease;
        position: relative;
      }

      #ruleInfo .rule-controls input[type="checkbox"]:checked {
        background: var(--accent-primary);
        border-color: var(--accent-primary);
      }

      #ruleInfo .rule-controls input[type="checkbox"]:checked::after {
        content: '';
        position: absolute;
        left: 4px;
        top: 1px;
        width: 4px;
        height: 8px;
        border: solid var(--bg-deep);
        border-width: 0 2px 2px 0;
        transform: rotate(45deg);
      }

      #ruleInfo .rule-tags {
        display: flex;
        flex-wrap: wrap;
        gap: 4px;
        margin-top: 8px;
      }

      #ruleInfo .rule-tag {
        border: 1px solid var(--border-subtle);
        border-radius: var(--radius-sm);
        padding: 3px 8px;
        font-size: 9px;
        color: var(--text-tertiary);
        background: var(--bg-elevated);
        text-transform: uppercase;
        letter-spacing: 0.05em;
      }

      /* Config Modal Backdrop */
      #configBackdrop {
        position: fixed;
        inset: 0;
        background: rgba(0, 0, 0, 0.7);
        backdrop-filter: blur(4px);
        z-index: 99;
        opacity: 0;
        visibility: hidden;
        transition: opacity 0.2s ease, visibility 0.2s ease;
      }

      #configBackdrop.visible {
        opacity: 1;
        visibility: visible;
      }

      /* Config Panel - Modal */
      #configPanel {
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%) scale(0.95);
        width: calc(100% - 40px);
        max-width: 680px;
        max-height: calc(100% - 80px);
        z-index: 100;
        border: 1px solid var(--border-strong);
        border-radius: var(--radius-lg);
        background: var(--bg-base);
        display: none;
        flex-direction: column;
        overflow: hidden;
        opacity: 0;
        transition: opacity 0.2s ease, transform 0.2s ease;
      }

      #configPanel.visible {
        display: flex;
        opacity: 1;
        transform: translate(-50%, -50%) scale(1);
        box-shadow: 0 25px 80px rgba(0, 0, 0, 0.5), 0 0 0 1px var(--accent-primary), 0 0 60px var(--accent-glow);
      }

      /* Config Header */
      .config-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 16px 20px;
        border-bottom: 1px solid var(--border-subtle);
        background: var(--bg-elevated);
      }

      .config-header h3 {
        margin: 0;
        font-size: 13px;
        font-weight: 600;
        color: var(--text-primary);
        display: flex;
        align-items: center;
        gap: 10px;
      }

      .config-header h3::before {
        content: '';
        width: 8px;
        height: 8px;
        background: var(--accent-primary);
        border-radius: 2px;
        box-shadow: 0 0 12px var(--accent-primary);
      }

      .config-close-btn {
        width: 32px;
        height: 32px;
        border: 1px solid var(--border-default);
        border-radius: var(--radius-sm);
        background: var(--bg-surface);
        color: var(--text-tertiary);
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 18px;
        transition: all 0.15s ease;
      }

      .config-close-btn:hover {
        background: var(--error-surface);
        border-color: var(--error);
        color: var(--error);
      }

      /* Config Tabs */
      .config-tabs {
        display: flex;
        gap: 0;
        padding: 0 20px;
        border-bottom: 1px solid var(--border-subtle);
        background: var(--bg-elevated);
      }

      .config-tab {
        padding: 12px 20px;
        border: none;
        background: transparent;
        color: var(--text-tertiary);
        font-family: inherit;
        font-size: 11px;
        font-weight: 500;
        text-transform: uppercase;
        letter-spacing: 0.05em;
        cursor: pointer;
        position: relative;
        transition: color 0.15s ease;
      }

      .config-tab:hover {
        color: var(--text-secondary);
      }

      .config-tab.active {
        color: var(--accent-primary);
      }

      .config-tab.active::after {
        content: '';
        position: absolute;
        bottom: -1px;
        left: 0;
        right: 0;
        height: 2px;
        background: var(--accent-primary);
        box-shadow: 0 0 10px var(--accent-primary);
      }

      /* Config Body */
      .config-body {
        flex: 1;
        overflow-y: auto;
        padding: 20px;
      }

      .config-tab-content {
        display: none;
        flex-direction: column;
        gap: 16px;
        animation: fadeIn 0.2s ease-out;
      }

      .config-tab-content.active {
        display: flex;
      }

      /* Config Sections */
      .config-section {
        display: flex;
        flex-direction: column;
        gap: 12px;
      }

      .config-section-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
      }

      .config-section strong {
        font-size: 11px;
        color: var(--text-secondary);
        text-transform: uppercase;
        letter-spacing: 0.08em;
        font-weight: 600;
      }

      .config-note {
        font-size: 10px;
        color: var(--text-disabled);
        padding: 8px 12px;
        background: var(--bg-elevated);
        border-radius: var(--radius-sm);
        border-left: 2px solid var(--accent-primary);
      }

      .config-row {
        display: grid;
        grid-template-columns: 140px 1fr;
        gap: 12px;
        align-items: center;
        font-size: 11px;
        color: var(--text-tertiary);
      }

      .config-input {
        border: 1px solid var(--border-default);
        border-radius: var(--radius-sm);
        padding: 10px 12px;
        font-size: 11px;
        font-family: inherit;
        background: var(--bg-surface);
        color: var(--text-primary);
        transition: all 0.15s ease;
      }

      .config-input:hover {
        border-color: var(--border-strong);
      }

      .config-input:focus {
        outline: none;
        border-color: var(--accent-primary);
        box-shadow: 0 0 0 3px var(--accent-glow);
        background: var(--bg-elevated);
      }

      .config-input:disabled {
        opacity: 0.5;
        cursor: not-allowed;
      }

      .warning-list {
        font-size: 10px;
        color: var(--warning);
        display: flex;
        flex-direction: column;
        gap: 4px;
        padding: 10px 12px;
        background: rgba(255, 183, 77, 0.08);
        border-radius: var(--radius-sm);
        border: 1px solid rgba(255, 183, 77, 0.2);
      }

      .hotkey-list,
      .rule-editor-list {
        display: flex;
        flex-direction: column;
        gap: 8px;
      }

      .hotkey-item {
        display: grid;
        grid-template-columns: 160px 1fr auto;
        gap: 10px;
        align-items: center;
        padding: 10px 12px;
        background: var(--bg-elevated);
        border-radius: var(--radius-sm);
        border: 1px solid var(--border-subtle);
      }

      .hotkey-item.add-new {
        background: transparent;
        border-style: dashed;
        border-color: var(--border-default);
      }

      /* Collapsible Rule Items */
      .rule-item {
        border: 1px solid var(--border-subtle);
        border-radius: var(--radius-sm);
        background: var(--bg-elevated);
        overflow: hidden;
        transition: all 0.15s ease;
      }

      .rule-item:hover {
        border-color: var(--border-default);
      }

      .rule-item-header {
        display: flex;
        align-items: center;
        gap: 12px;
        padding: 12px 14px;
        cursor: pointer;
        transition: background 0.15s ease;
      }

      .rule-item-header:hover {
        background: var(--bg-hover);
      }

      .rule-item-chevron {
        width: 20px;
        height: 20px;
        display: flex;
        align-items: center;
        justify-content: center;
        color: var(--text-tertiary);
        transition: transform 0.2s ease;
        font-size: 10px;
      }

      .rule-item.expanded .rule-item-chevron {
        transform: rotate(90deg);
      }

      .rule-item-name {
        flex: 1;
        font-size: 12px;
        font-weight: 500;
        color: var(--text-primary);
      }

      .rule-item-badges {
        display: flex;
        gap: 6px;
      }

      .rule-item-badge {
        padding: 3px 8px;
        font-size: 9px;
        text-transform: uppercase;
        letter-spacing: 0.05em;
        border-radius: 3px;
        font-weight: 600;
      }

      .rule-item-badge.pinned {
        background: var(--accent-surface);
        color: var(--accent-primary);
        border: 1px solid var(--accent-primary);
      }

      .rule-item-badge.auto {
        background: rgba(255, 183, 77, 0.1);
        color: var(--warning);
        border: 1px solid rgba(255, 183, 77, 0.3);
      }

      .rule-item-body {
        display: none;
        padding: 0 14px 14px;
        flex-direction: column;
        gap: 12px;
        border-top: 1px solid var(--border-subtle);
        animation: fadeIn 0.15s ease-out;
      }

      .rule-item.expanded .rule-item-body {
        display: flex;
      }

      .rule-item-row {
        display: flex;
        align-items: center;
        gap: 12px;
      }

      .rule-item-row label {
        font-size: 11px;
        color: var(--text-tertiary);
        min-width: 80px;
      }

      .rule-item-row .config-input {
        flex: 1;
      }

      .rule-item-controls {
        display: flex;
        gap: 16px;
        padding-top: 8px;
      }

      .rule-item-controls label {
        display: flex;
        align-items: center;
        gap: 8px;
        font-size: 11px;
        color: var(--text-tertiary);
        cursor: pointer;
      }

      .remove-btn {
        border: 1px solid var(--border-default);
        border-radius: var(--radius-sm);
        padding: 8px 14px;
        background: var(--bg-surface);
        cursor: pointer;
        font-size: 10px;
        font-family: inherit;
        color: var(--text-tertiary);
        transition: all 0.15s ease;
        text-transform: uppercase;
        letter-spacing: 0.05em;
        font-weight: 500;
      }

      .remove-btn:hover {
        background: var(--error-surface);
        border-color: var(--error);
        color: var(--error);
      }

      .remove-btn:disabled {
        opacity: 0.5;
        cursor: not-allowed;
      }

      .add-btn {
        border: 1px solid var(--accent-primary);
        border-radius: var(--radius-sm);
        padding: 8px 14px;
        background: var(--accent-surface);
        cursor: pointer;
        font-size: 10px;
        font-family: inherit;
        color: var(--accent-primary);
        transition: all 0.15s ease;
        text-transform: uppercase;
        letter-spacing: 0.05em;
        font-weight: 500;
      }

      .add-btn:hover {
        background: var(--accent-primary);
        color: var(--bg-deep);
      }

      .add-btn:disabled {
        opacity: 0.5;
        cursor: not-allowed;
      }

      #configDirtyNotice {
        color: var(--warning);
        font-size: 11px;
        padding: 10px 14px;
        background: rgba(255, 183, 77, 0.1);
        border-radius: var(--radius-sm);
        border: 1px solid rgba(255, 183, 77, 0.25);
        display: flex;
        align-items: center;
        gap: 10px;
      }

      #configDirtyNotice::before {
        content: '⚠';
        font-size: 14px;
      }

      #configText {
        width: 100%;
        min-height: 240px;
        border: 1px solid var(--border-default);
        border-radius: var(--radius-sm);
        padding: 14px;
        font-family: inherit;
        font-size: 11px;
        background: var(--bg-surface);
        color: var(--text-primary);
        resize: vertical;
        transition: all 0.15s ease;
        line-height: 1.7;
      }

      #configText:focus {
        outline: none;
        border-color: var(--accent-primary);
        box-shadow: 0 0 0 3px var(--accent-glow);
      }

      #configDiff {
        width: 100%;
        min-height: 80px;
        max-height: 160px;
        overflow-y: auto;
        border: 1px dashed var(--border-default);
        border-radius: var(--radius-sm);
        padding: 12px;
        font-family: inherit;
        font-size: 10px;
        white-space: pre-wrap;
        background: var(--bg-elevated);
        color: var(--text-tertiary);
        line-height: 1.6;
      }

      #configDiff.empty {
        color: var(--text-disabled);
        min-height: 40px;
      }

      /* Config Footer */
      .config-footer {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 16px 20px;
        border-top: 1px solid var(--border-subtle);
        background: var(--bg-elevated);
      }

      .config-footer-left {
        display: flex;
        align-items: center;
        gap: 12px;
      }

      .config-footer-right {
        display: flex;
        gap: 8px;
      }

      #configError,
      #configDraftError {
        color: var(--error);
        font-size: 11px;
        padding: 8px 12px;
        background: var(--error-surface);
        border-radius: var(--radius-sm);
        border: 1px solid rgba(244, 67, 54, 0.3);
      }

      /* Toast Notification */
      #toast {
        position: fixed;
        bottom: 100px;
        left: 50%;
        transform: translateX(-50%) translateY(20px);
        padding: 12px 24px;
        background: var(--accent-primary);
        color: var(--bg-deep);
        font-size: 12px;
        font-weight: 600;
        border-radius: var(--radius-md);
        box-shadow: 0 8px 30px rgba(0, 255, 200, 0.3);
        opacity: 0;
        visibility: hidden;
        transition: all 0.3s ease;
        z-index: 200;
      }

      #toast.visible {
        opacity: 1;
        visibility: visible;
        transform: translateX(-50%) translateY(0);
      }

      #toast.error {
        background: var(--error);
        box-shadow: 0 8px 30px rgba(244, 67, 54, 0.3);
      }

      /* Recent Panel */
      #recentList {
        display: flex;
        flex-direction: column;
        gap: 8px;
      }

      .history-item {
        border: 1px solid var(--border-subtle);
        border-radius: var(--radius-sm);
        padding: 10px;
        background: var(--bg-elevated);
        font-size: 10px;
        color: var(--text-tertiary);
        display: flex;
        flex-direction: column;
        gap: 4px;
        animation: slideIn 0.2s ease-out;
        transition: all 0.15s ease;
      }

      .history-item:hover {
        border-color: var(--border-default);
        background: var(--bg-hover);
      }

      .history-item strong {
        color: var(--text-secondary);
        font-size: 11px;
        font-weight: 500;
      }

      /* Actions Footer */
      #actions {
        position: relative;
        z-index: 1;
        padding: 14px 20px 18px;
        display: flex;
        justify-content: flex-end;
        gap: 8px;
        border-top: 1px solid var(--border-subtle);
        background: linear-gradient(180deg, var(--bg-deep) 0%, rgba(10, 11, 13, 0.95) 100%);
      }

      button.action {
        padding: 10px 18px;
        border-radius: var(--radius-sm);
        border: 1px solid var(--border-default);
        background: var(--bg-surface);
        cursor: pointer;
        font-weight: 600;
        font-family: inherit;
        font-size: 11px;
        color: var(--text-secondary);
        transition: all 0.15s ease;
        text-transform: uppercase;
        letter-spacing: 0.05em;
        display: flex;
        align-items: center;
        gap: 8px;
      }

      button.action:hover {
        background: var(--bg-hover);
        border-color: var(--border-strong);
        color: var(--text-primary);
      }

      button.primary {
        background: var(--accent-primary);
        color: var(--bg-deep);
        border-color: var(--accent-primary);
        box-shadow: 0 0 20px var(--accent-glow);
      }

      button.primary:hover {
        background: var(--accent-secondary);
        border-color: var(--accent-secondary);
        box-shadow: 0 0 30px var(--accent-glow);
        transform: translateY(-1px);
      }

      kbd {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        padding: 2px 6px;
        font-size: 9px;
        font-family: inherit;
        background: rgba(255, 255, 255, 0.06);
        border-radius: 3px;
        border: 1px solid rgba(255, 255, 255, 0.1);
        color: var(--text-tertiary);
        font-weight: 500;
      }

      button.primary kbd {
        background: rgba(0, 0, 0, 0.2);
        border-color: rgba(0, 0, 0, 0.3);
        color: rgba(0, 0, 0, 0.7);
      }

      #helpBtn {
        min-width: 40px;
        padding: 10px 14px;
        font-weight: 700;
        font-size: 13px;
      }

      /* Help Overlay */
      .help-overlay {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.8);
        backdrop-filter: blur(8px);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 1000;
      }

      .help-overlay[hidden] {
        display: none;
      }

      .help-content {
        background: var(--bg-base);
        border: 1px solid var(--border-default);
        border-radius: var(--radius-lg);
        padding: 28px;
        max-width: 580px;
        box-shadow: 0 25px 80px rgba(0, 0, 0, 0.5), 0 0 60px var(--accent-glow);
        animation: fadeIn 0.2s ease-out;
      }

      .help-content h3 {
        margin: 0 0 20px;
        font-size: 14px;
        color: var(--text-primary);
        text-transform: uppercase;
        letter-spacing: 0.1em;
        font-weight: 600;
        display: flex;
        align-items: center;
        gap: 10px;
      }

      .help-content h3::before {
        content: '';
        width: 8px;
        height: 8px;
        background: var(--accent-primary);
        border-radius: 2px;
        box-shadow: 0 0 12px var(--accent-primary);
      }

      .help-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 24px;
        margin-bottom: 24px;
      }

      .help-section h4 {
        margin: 0 0 12px;
        font-size: 9px;
        text-transform: uppercase;
        letter-spacing: 0.15em;
        color: var(--text-tertiary);
        font-weight: 600;
      }

      .help-row {
        display: flex;
        align-items: center;
        gap: 10px;
        margin-bottom: 8px;
        font-size: 11px;
      }

      .help-row kbd {
        min-width: 28px;
        text-align: center;
      }

      .help-row span {
        color: var(--text-secondary);
      }

      .help-content .action {
        width: 100%;
        margin-top: 8px;
        justify-content: center;
      }

      /* Responsive Design */

      /* Large tablets and small desktops */
      @media (max-width: 1100px) {
        main {
          grid-template-columns: 1fr 1fr;
        }
        #ruleInfo {
          grid-column: 1 / -1;
          grid-row: 1;
        }
        #recentPanel {
          display: none;
        }
        #diff {
          grid-column: 1 / -1;
        }
      }

      /* Tablets */
      @media (max-width: 900px) {
        main {
          grid-template-columns: 1fr;
        }
        .header-row {
          flex-direction: column;
          align-items: stretch;
          gap: 12px;
        }
        #ruleSearch {
          width: 100%;
          min-width: 0;
        }
        .pane {
          min-height: 120px;
        }
        #ruleInfo {
          grid-column: 1;
          grid-row: auto;
        }
        #diff {
          grid-column: 1;
        }
        #badges {
          flex-wrap: wrap;
        }
        #meta {
          flex-wrap: wrap;
          gap: 10px;
        }
      }

      /* Large phones / small tablets */
      @media (max-width: 700px) {
        header {
          padding: 12px 16px 10px;
          gap: 10px;
        }
        main {
          padding: 12px 16px;
          gap: 10px;
        }
        .pane {
          min-height: 100px;
          padding: 12px;
        }
        .pane h3 {
          font-size: 8px;
          margin-bottom: 10px;
        }
        pre {
          font-size: 11px;
          line-height: 1.5;
        }
        .rule-button {
          font-size: 10px;
          padding: 6px 10px;
        }
        #suggestions {
          gap: 4px;
        }
        #ruleInfo {
          display: none;
        }
        #metrics {
          display: none;
        }
        #actions {
          padding: 12px 16px 14px;
          gap: 6px;
        }
        #actions button.action {
          padding: 10px 14px;
          font-size: 10px;
        }
        #actions kbd {
          display: none;
        }
      }

      /* Phones */
      @media (max-width: 500px) {
        header {
          padding: 10px 12px 8px;
          gap: 8px;
        }
        main {
          padding: 10px 12px;
          gap: 8px;
        }
        .pane {
          min-height: 80px;
          padding: 10px;
        }
        pre {
          font-size: 10px;
        }
        .rule-button {
          font-size: 9px;
          padding: 5px 8px;
          letter-spacing: 0.02em;
        }
        .rule-badges {
          display: none;
        }
        .badge {
          font-size: 8px;
          padding: 2px 6px;
        }
        #badges {
          gap: 4px;
        }
        #configPanel {
          width: calc(100% - 24px);
          max-height: calc(100% - 40px);
        }
        .config-header {
          padding: 12px 16px;
        }
        .config-tabs {
          padding: 0 16px;
        }
        .config-tab {
          padding: 10px 14px;
          font-size: 10px;
        }
        .config-body {
          padding: 16px;
        }
        .config-footer {
          padding: 12px 16px;
          flex-direction: column;
          gap: 10px;
        }
        .config-footer-left,
        .config-footer-right {
          width: 100%;
          justify-content: center;
        }
        .hotkey-item {
          grid-template-columns: 1fr;
          gap: 8px;
        }
        .rule-item-header {
          padding: 10px 12px;
        }
        .rule-item-body {
          padding: 0 12px 12px;
        }
        .config-section strong {
          font-size: 10px;
        }
        .config-row {
          grid-template-columns: 1fr;
          gap: 6px;
          font-size: 10px;
        }
        .config-input {
          padding: 6px 8px;
          font-size: 10px;
        }
        .hotkey-item, .rule-item {
          grid-template-columns: 1fr;
          gap: 6px;
        }
        .help-overlay {
          padding: 12px;
        }
        .help-content {
          padding: 16px;
          max-width: 100%;
        }
        .help-content h3 {
          font-size: 12px;
          margin-bottom: 16px;
        }
        .help-grid {
          grid-template-columns: 1fr;
          gap: 16px;
        }
        .help-row {
          font-size: 10px;
          gap: 8px;
        }
        .help-row kbd {
          min-width: 24px;
          padding: 2px 4px;
          font-size: 8px;
        }
        #actions {
          padding: 10px 12px 12px;
          flex-wrap: wrap;
        }
        #actions button.action {
          flex: 1 1 calc(50% - 4px);
          min-width: 0;
          padding: 10px 10px;
          justify-content: center;
        }
        #helpBtn {
          flex: 0 0 auto;
          min-width: 36px;
        }
      }

      /* Very small screens */
      @media (max-width: 380px) {
        .search-wrap {
          flex-direction: column;
          align-items: stretch;
        }
        #configToggle {
          width: 100%;
          text-align: center;
        }
        #actions button.action {
          flex: 1 1 100%;
        }
        #actions button.primary {
          order: -1;
        }
      }

      /* Height-constrained screens */
      @media (max-height: 500px) {
        header {
          padding: 8px 16px 6px;
          gap: 6px;
        }
        main {
          padding: 8px 16px;
          gap: 6px;
        }
        .pane {
          min-height: 60px;
        }
        #badges, #meta, #metrics {
          display: none;
        }
        #actions {
          padding: 8px 16px 10px;
        }
      }
    </style>
  </head>
  <body>
    <header>
      <div class="header-row">
        <div id="suggestions"></div>
        <div class="search-wrap">
          <input id="ruleSearch" type="search" placeholder="/ search rules..." aria-label="Search rules by name or ID" />
          <button id="configToggle" aria-label="Edit configuration settings">Config</button>
        </div>
      </div>
      <div id="badges">
        <span class="badge" id="appBadge">App: -</span>
        <span class="badge" id="typeBadge">Types: -</span>
      </div>
      <div id="metrics"></div>
      <div id="meta">
        <label>
          <input type="checkbox" id="autoAccept" />
          Auto-accept this rule
        </label>
        <span id="remote-badge" hidden>Remote</span>
      </div>
    </header>
    <div id="errorBanner"></div>
    <main>
      <section class="pane">
        <h3>Before</h3>
        <pre id="before"></pre>
      </section>
      <section class="pane">
        <h3>After</h3>
        <pre id="after"></pre>
      </section>
      <section class="pane" id="ruleInfo">
        <h3>Rule Info</h3>
        <div class="rule-name" id="ruleInfoName">-</div>
        <div class="rule-controls">
          <label>
            <input type="checkbox" id="pinRule" />
            Pin this rule
          </label>
        </div>
        <div class="rule-line" id="ruleInfoDetail"></div>
        <div class="rule-line" id="ruleInfoMatch"></div>
        <div class="rule-line" id="ruleInfoScore"></div>
        <div class="rule-tags" id="ruleInfoTags"></div>
      </section>
      <section class="pane" id="recentPanel">
        <h3>Recent</h3>
        <div id="recentList"></div>
      </section>
      <section class="pane" id="diff">
        <h3>Diff</h3>
        <pre id="diffText"></pre>
      </section>
    </main>
    <!-- Config Modal Backdrop -->
    <div id="configBackdrop"></div>

    <!-- Config Modal -->
    <section id="configPanel" role="dialog" aria-modal="true" aria-labelledby="configTitle">
      <div class="config-header">
        <h3 id="configTitle">Settings</h3>
        <button class="config-close-btn" id="configCloseX" aria-label="Close settings">×</button>
      </div>

      <div class="config-tabs" role="tablist">
        <button class="config-tab active" data-tab="hotkeys" role="tab" aria-selected="true">Hotkeys</button>
        <button class="config-tab" data-tab="rules" role="tab" aria-selected="false">Rules</button>
        <button class="config-tab" data-tab="advanced" role="tab" aria-selected="false">Advanced</button>
      </div>

      <div class="config-body">
        <!-- Hotkeys Tab -->
        <div class="config-tab-content active" data-tab-content="hotkeys">
          <div class="config-note">Hotkey changes apply immediately. Use Cmd/Ctrl + modifiers + key format.</div>
          <div class="warning-list" id="hotkeyWarnings" hidden></div>

          <div class="config-section">
            <strong>Global Trigger</strong>
            <div class="config-row">
              <span>Default hotkey</span>
              <input class="config-input" id="hotkeyCombo" placeholder="Cmd+Shift+V" />
            </div>
          </div>

          <div class="config-section">
            <div class="config-section-header">
              <strong>App-Specific Overrides</strong>
            </div>
            <div class="hotkey-list" id="hotkeyList"></div>
            <div class="hotkey-item add-new">
              <input class="config-input" id="hotkeyAppInput" placeholder="App name (e.g. Slack)" />
              <input class="config-input" id="hotkeyComboInput" placeholder="Cmd+Shift+P" />
              <button class="add-btn" id="hotkeyAddBtn">+ Add</button>
            </div>
          </div>
        </div>

        <!-- Rules Tab -->
        <div class="config-tab-content" data-tab-content="rules">
          <div class="config-note">Click a rule to expand and edit its settings. Pinned rules appear first in suggestions.</div>
          <div class="rule-editor-list" id="ruleEditorList"></div>
        </div>

        <!-- Advanced Tab -->
        <div class="config-tab-content" data-tab-content="advanced">
          <div id="configDirtyNotice" hidden>Raw editor has unsaved changes. Other tabs are read-only until you save or revert.</div>

          <div class="config-section">
            <strong>Raw Configuration (TOML)</strong>
            <div class="config-note">Edit the raw config file directly. Be careful with syntax!</div>
            <textarea id="configText" spellcheck="false" placeholder="Loading configuration..."></textarea>
            <div id="configDraftError"></div>
          </div>

          <div class="config-section">
            <strong>Pending Changes</strong>
            <div id="configDiff" class="empty">No changes.</div>
          </div>

          <div id="configError"></div>
        </div>
      </div>

      <div class="config-footer">
        <div class="config-footer-left">
          <button class="action" id="configRevert" disabled>Revert</button>
          <button class="action" id="configReload">Reload</button>
        </div>
        <div class="config-footer-right">
          <button class="action" id="configClose">Close <kbd>Esc</kbd></button>
          <button class="action primary" id="configSave">Save Changes</button>
        </div>
      </div>
    </section>

    <!-- Toast Notification -->
    <div id="toast"></div>
    <div id="actions">
      <button class="action" id="helpBtn" title="Keyboard shortcuts">?</button>
      <button class="action" id="copy" aria-label="Copy transformed text to clipboard">Copy <kbd>⇧⌘C</kbd></button>
      <button class="action primary" id="paste" aria-label="Paste transformed text">Paste <kbd>⌘↵</kbd></button>
      <button class="action" id="cancel" aria-label="Cancel and close panel">Cancel <kbd>Esc</kbd></button>
    </div>
    <div id="helpOverlay" class="help-overlay" hidden role="dialog" aria-modal="true" aria-labelledby="helpTitle">
      <div class="help-content">
        <h3 id="helpTitle">Keyboard Shortcuts</h3>
        <div class="help-grid">
          <div class="help-section">
            <h4>Actions</h4>
            <div class="help-row"><kbd>⌘↵</kbd><span>Paste transformed text</span></div>
            <div class="help-row"><kbd>⇧⌘C</kbd><span>Copy to clipboard</span></div>
            <div class="help-row"><kbd>Esc</kbd><span>Cancel / Close</span></div>
          </div>
          <div class="help-section">
            <h4>Navigation</h4>
            <div class="help-row"><kbd>↑</kbd> <kbd>↓</kbd><span>Select rule</span></div>
            <div class="help-row"><kbd>Tab</kbd><span>Next rule</span></div>
            <div class="help-row"><kbd>⇧Tab</kbd><span>Previous rule</span></div>
            <div class="help-row"><kbd>1-9</kbd><span>Quick select rule</span></div>
          </div>
          <div class="help-section">
            <h4>Search</h4>
            <div class="help-row"><kbd>/</kbd> or <kbd>⌘K</kbd><span>Focus search</span></div>
            <div class="help-row"><kbd>↵</kbd><span>Select & paste first result</span></div>
          </div>
          <div class="help-section">
            <h4>Rules</h4>
            <div class="help-row"><kbd>⌘P</kbd><span>Toggle pin on selected</span></div>
            <div class="help-row"><kbd>?</kbd><span>Show this help</span></div>
          </div>
        </div>
        <button class="action" id="helpClose">Close <kbd>Esc</kbd></button>
      </div>
    </div>
    <script>
      const state = {
        suggestions: [],
        allRules: [],
        selectedRuleId: null,
        before: "",
        after: "",
        diff: "",
        activeApp: null,
        contentTypes: [],
        config: { hotkey_combo: "", hotkey_apps: [], rules: [] },
        configText: null,
        configError: null,
        configDraftError: null,
        configDiff: null,
        history: [],
        stats: null,
        error: null,
      };

      let searchQuery = "";
      let configOpen = false;
      let configDirty = false;
      let configDraftTimer = null;
      let helpOverlayVisible = false;
      let activeConfigTab = "hotkeys";
      let expandedRules = new Set();
      let toastTimer = null;

      function toggleHelpOverlay() {
        helpOverlayVisible = !helpOverlayVisible;
        document.getElementById("helpOverlay").hidden = !helpOverlayVisible;
      }

      function showToast(message, isError = false) {
        const toast = document.getElementById("toast");
        toast.textContent = message;
        toast.classList.toggle("error", isError);
        toast.classList.add("visible");
        if (toastTimer) clearTimeout(toastTimer);
        toastTimer = setTimeout(() => {
          toast.classList.remove("visible");
        }, 2500);
      }

      function switchConfigTab(tabName) {
        activeConfigTab = tabName;
        document.querySelectorAll(".config-tab").forEach(tab => {
          const isActive = tab.dataset.tab === tabName;
          tab.classList.toggle("active", isActive);
          tab.setAttribute("aria-selected", isActive);
        });
        document.querySelectorAll(".config-tab-content").forEach(content => {
          content.classList.toggle("active", content.dataset.tabContent === tabName);
        });
      }

      function toggleRuleExpanded(ruleId) {
        if (expandedRules.has(ruleId)) {
          expandedRules.delete(ruleId);
        } else {
          expandedRules.add(ruleId);
        }
        renderRuleEditor();
      }

      const searchInput = document.getElementById("ruleSearch");
      const configPanel = document.getElementById("configPanel");
      const configBackdrop = document.getElementById("configBackdrop");
      const configText = document.getElementById("configText");
      const hotkeyComboInput = document.getElementById("hotkeyCombo");
      const hotkeyList = document.getElementById("hotkeyList");
      const hotkeyAppInput = document.getElementById("hotkeyAppInput");
      const hotkeyComboAddInput = document.getElementById("hotkeyComboInput");
      const hotkeyAddBtn = document.getElementById("hotkeyAddBtn");
      const ruleEditorList = document.getElementById("ruleEditorList");
      const configDirtyNotice = document.getElementById("configDirtyNotice");
      const configDiff = document.getElementById("configDiff");
      const configDraftError = document.getElementById("configDraftError");
      const configRevertBtn = document.getElementById("configRevert");
      const hotkeyWarnings = document.getElementById("hotkeyWarnings");
      const recentList = document.getElementById("recentList");

      function visibleRules() {
        const list = searchQuery.trim()
          ? state.allRules.filter((rule) =>
              rule.name.toLowerCase().includes(searchQuery) || rule.id.toLowerCase().includes(searchQuery)
            )
          : state.suggestions;
        if (searchQuery.trim()) {
          list.sort((a, b) => {
            if (b.score !== a.score) return b.score - a.score;
            return a.name.localeCompare(b.name);
          });
        }
        return list.slice(0, searchQuery ? 10 : list.length);
      }

      function selectRule(id) {
        if (!id) return;
        window.ipc.postMessage(JSON.stringify({ type: "select_rule", id }));
      }

      function renderRules() {
        const suggestions = document.getElementById("suggestions");
        suggestions.innerHTML = "";
        const list = visibleRules();
        if (!list.length) {
          const empty = document.createElement("div");
          empty.className = "empty-state";
          empty.textContent = searchQuery ? "No rules match your search." : "No rules matched this clipboard.";
          suggestions.appendChild(empty);
          return;
        }
        list.forEach((rule) => {
          const btn = document.createElement("button");
          btn.className = "rule-button" + (rule.id === state.selectedRuleId ? " active" : "");
          const label = document.createElement("span");
          label.textContent = rule.name;
          btn.appendChild(label);

          const badges = document.createElement("span");
          badges.className = "rule-badges";
          if (rule.pinned) {
            const badge = document.createElement("span");
            badge.className = "rule-badge";
            badge.textContent = "P";
            badge.title = "Pinned";
            badges.appendChild(badge);
          }
          if (rule.auto_accept) {
            const badge = document.createElement("span");
            badge.className = "rule-badge";
            badge.textContent = "A";
            badge.title = "Auto-accept";
            badges.appendChild(badge);
          }
          if (rule.uses_remote) {
            const badge = document.createElement("span");
            badge.className = "rule-badge";
            badge.textContent = "R";
            badge.title = "Remote model";
            badges.appendChild(badge);
          }
          if (badges.children.length) {
            btn.appendChild(badges);
          }

          btn.onclick = () => selectRule(rule.id);
          suggestions.appendChild(btn);
        });
      }

      function renderRuleInfo() {
        const panel = document.getElementById("ruleInfo");
        const selected = state.allRules.find((rule) => rule.id === state.selectedRuleId);
        panel.classList.toggle("active", !!selected);
        document.getElementById("ruleInfoName").textContent = selected ? selected.name : "-";
        document.getElementById("ruleInfoDetail").textContent = selected ? selected.detail : "";
        document.getElementById("ruleInfoMatch").textContent = selected ? selected.match_hint : "";
        document.getElementById("ruleInfoScore").textContent = selected ? `Score: ${selected.score}` : "";
        const pinToggle = document.getElementById("pinRule");
        pinToggle.checked = selected ? !!selected.pinned : false;
        pinToggle.disabled = !selected;
        pinToggle.onchange = (event) => {
          if (!selected) return;
          window.ipc.postMessage(
            JSON.stringify({ type: "toggle_pinned", id: selected.id, value: event.target.checked })
          );
        };
        const tags = document.getElementById("ruleInfoTags");
        tags.innerHTML = "";
        if (!selected) return;
        if (selected.pinned) {
          const tag = document.createElement("span");
          tag.className = "rule-tag";
          tag.textContent = "Pinned";
          tags.appendChild(tag);
        }
        if (selected.auto_accept) {
          const tag = document.createElement("span");
          tag.className = "rule-tag";
          tag.textContent = "Auto-accept";
          tags.appendChild(tag);
        }
        if (selected.uses_remote) {
          const tag = document.createElement("span");
          tag.className = "rule-tag";
          tag.textContent = "Remote model";
          tags.appendChild(tag);
        }
      }

      function renderMeta() {
        const selected = state.allRules.find((rule) => rule.id === state.selectedRuleId);
        const autoAccept = document.getElementById("autoAccept");
        autoAccept.checked = selected ? selected.auto_accept : false;
        autoAccept.onchange = (event) => {
          if (!selected) return;
          window.ipc.postMessage(
            JSON.stringify({ type: "toggle_auto_accept", id: selected.id, value: event.target.checked })
          );
        };

        const badge = document.getElementById("remote-badge");
        badge.hidden = !(selected && selected.uses_remote);

        document.getElementById("appBadge").textContent = `App: ${state.activeApp || "-"}`;
        const types = state.contentTypes.length ? state.contentTypes.join(", ") : "-";
        document.getElementById("typeBadge").textContent = `Types: ${types}`;
        const metrics = state.stats
          ? `Before ${state.stats.before_chars}c/${state.stats.before_lines}l · After ${state.stats.after_chars}c/${state.stats.after_lines}l · Δ +${state.stats.diff_added}/-${state.stats.diff_removed}`
          : "";
        document.getElementById("metrics").textContent = metrics;
      }

      function renderConfig() {
        configPanel.classList.toggle("visible", configOpen);
        configBackdrop.classList.toggle("visible", configOpen);
        document.getElementById("configToggle").classList.toggle("active", configOpen);
        configDirtyNotice.hidden = !configDirty;

        const hasConfig = !!state.configText;
        if (configOpen && hasConfig && !configDirty) {
          configText.value = state.configText;
        }
        if (configOpen && !hasConfig) {
          configText.value = "";
          configText.placeholder = "Loading configuration...";
        }
        configText.disabled = !hasConfig;

        const errorEl = document.getElementById("configError");
        if (state.configError) {
          errorEl.textContent = state.configError;
          errorEl.style.display = "block";
        } else {
          errorEl.style.display = "none";
        }

        if (state.configDraftError) {
          configDraftError.textContent = state.configDraftError;
          configDraftError.style.display = "block";
        } else {
          configDraftError.style.display = "none";
        }

        if (state.configDiff && state.configDiff.trim().length) {
          configDiff.textContent = state.configDiff;
          configDiff.classList.remove("empty");
        } else {
          configDiff.textContent = "No changes.";
          configDiff.classList.add("empty");
        }

        const disabled = configDirty;
        hotkeyComboInput.disabled = disabled;
        hotkeyAppInput.disabled = disabled;
        hotkeyComboAddInput.disabled = disabled;
        hotkeyAddBtn.disabled = disabled;
        configRevertBtn.disabled = !configDirty;

        // Hotkey combo
        hotkeyComboInput.value = state.config.hotkey_combo || "";
        hotkeyComboInput.onchange = (event) => {
          if (disabled) return;
          window.ipc.postMessage(JSON.stringify({ type: "update_hotkey_combo", combo: event.target.value }));
          showToast("Hotkey updated");
        };

        // Hotkey warnings
        if (state.config.hotkey_warnings && state.config.hotkey_warnings.length) {
          hotkeyWarnings.hidden = false;
          hotkeyWarnings.innerHTML = "";
          state.config.hotkey_warnings.forEach((warning) => {
            const line = document.createElement("div");
            line.textContent = warning;
            hotkeyWarnings.appendChild(line);
          });
        } else {
          hotkeyWarnings.hidden = true;
        }

        // Hotkey list
        hotkeyList.innerHTML = "";
        (state.config.hotkey_apps || []).forEach((entry) => {
          const row = document.createElement("div");
          row.className = "hotkey-item";

          const appLabel = document.createElement("input");
          appLabel.className = "config-input";
          appLabel.value = entry.app;
          appLabel.disabled = true;
          appLabel.style.opacity = "0.7";

          const comboInput = document.createElement("input");
          comboInput.className = "config-input";
          comboInput.value = entry.combo;
          comboInput.disabled = disabled;
          comboInput.onchange = (event) => {
            if (disabled) return;
            window.ipc.postMessage(
              JSON.stringify({ type: "update_hotkey_app", app: entry.app, combo: event.target.value })
            );
            showToast(`Hotkey for ${entry.app} updated`);
          };

          const removeBtn = document.createElement("button");
          removeBtn.className = "remove-btn";
          removeBtn.textContent = "Remove";
          removeBtn.disabled = disabled;
          removeBtn.onclick = () => {
            if (disabled) return;
            window.ipc.postMessage(JSON.stringify({ type: "remove_hotkey_app", app: entry.app }));
            showToast(`Removed hotkey for ${entry.app}`);
          };

          row.appendChild(appLabel);
          row.appendChild(comboInput);
          row.appendChild(removeBtn);
          hotkeyList.appendChild(row);
        });

        // Add hotkey button
        hotkeyAddBtn.onclick = () => {
          if (disabled) return;
          const app = hotkeyAppInput.value.trim();
          const combo = hotkeyComboAddInput.value.trim();
          if (!app || !combo) return;
          window.ipc.postMessage(JSON.stringify({ type: "update_hotkey_app", app, combo }));
          hotkeyAppInput.value = "";
          hotkeyComboAddInput.value = "";
          showToast(`Added hotkey for ${app}`);
        };

        renderRuleEditor();
      }

      function renderRuleEditor() {
        const disabled = configDirty;
        ruleEditorList.innerHTML = "";

        if (!state.config.rules || state.config.rules.length === 0) {
          const empty = document.createElement("div");
          empty.className = "empty-state";
          empty.textContent = "No rules configured yet.";
          ruleEditorList.appendChild(empty);
          return;
        }

        (state.config.rules || []).forEach((rule) => {
          const isExpanded = expandedRules.has(rule.id);
          const item = document.createElement("div");
          item.className = "rule-item" + (isExpanded ? " expanded" : "");

          // Header (clickable to expand/collapse)
          const header = document.createElement("div");
          header.className = "rule-item-header";
          header.onclick = () => toggleRuleExpanded(rule.id);

          const chevron = document.createElement("div");
          chevron.className = "rule-item-chevron";
          chevron.textContent = "▶";

          const name = document.createElement("div");
          name.className = "rule-item-name";
          name.textContent = rule.name;

          const badges = document.createElement("div");
          badges.className = "rule-item-badges";
          if (rule.pinned) {
            const badge = document.createElement("span");
            badge.className = "rule-item-badge pinned";
            badge.textContent = "Pinned";
            badges.appendChild(badge);
          }
          if (rule.auto_accept) {
            const badge = document.createElement("span");
            badge.className = "rule-item-badge auto";
            badge.textContent = "Auto";
            badges.appendChild(badge);
          }

          header.appendChild(chevron);
          header.appendChild(name);
          header.appendChild(badges);

          // Body (expandable content)
          const body = document.createElement("div");
          body.className = "rule-item-body";

          // Description row
          const descRow = document.createElement("div");
          descRow.className = "rule-item-row";
          const descLabel = document.createElement("label");
          descLabel.textContent = "Description";
          const descInput = document.createElement("input");
          descInput.className = "config-input";
          descInput.value = rule.description || "";
          descInput.placeholder = "Optional description...";
          descInput.disabled = disabled;
          descInput.onchange = (event) => {
            if (disabled) return;
            window.ipc.postMessage(
              JSON.stringify({ type: "update_rule_description", id: rule.id, value: event.target.value })
            );
            showToast("Rule updated");
          };
          descRow.appendChild(descLabel);
          descRow.appendChild(descInput);

          // Controls row
          const controls = document.createElement("div");
          controls.className = "rule-item-controls";

          const pinLabel = document.createElement("label");
          const pinInput = document.createElement("input");
          pinInput.type = "checkbox";
          pinInput.checked = !!rule.pinned;
          pinInput.disabled = disabled;
          pinInput.onchange = (event) => {
            if (disabled) return;
            window.ipc.postMessage(
              JSON.stringify({ type: "toggle_pinned", id: rule.id, value: event.target.checked })
            );
            showToast(event.target.checked ? "Rule pinned" : "Rule unpinned");
          };
          pinLabel.appendChild(pinInput);
          pinLabel.appendChild(document.createTextNode(" Pin to top"));

          const autoLabel = document.createElement("label");
          const autoInput = document.createElement("input");
          autoInput.type = "checkbox";
          autoInput.checked = !!rule.auto_accept;
          autoInput.disabled = disabled;
          autoInput.onchange = (event) => {
            if (disabled) return;
            window.ipc.postMessage(
              JSON.stringify({ type: "toggle_auto_accept", id: rule.id, value: event.target.checked })
            );
            showToast(event.target.checked ? "Auto-accept enabled" : "Auto-accept disabled");
          };
          autoLabel.appendChild(autoInput);
          autoLabel.appendChild(document.createTextNode(" Auto-accept"));

          controls.appendChild(pinLabel);
          controls.appendChild(autoLabel);

          body.appendChild(descRow);
          body.appendChild(controls);

          item.appendChild(header);
          item.appendChild(body);
          ruleEditorList.appendChild(item);
        });
      }

      function render() {
        renderRules();
        renderMeta();
        renderRuleInfo();
        renderHistory();
        const errorBanner = document.getElementById("errorBanner");
        if (state.error) {
          errorBanner.textContent = state.error;
          errorBanner.style.display = "block";
        } else {
          errorBanner.textContent = "";
          errorBanner.style.display = "none";
        }
        const beforeEl = document.getElementById("before");
        const afterEl = document.getElementById("after");
        const diffEl = document.getElementById("diffText");

        if (state.before && state.before.length) {
          beforeEl.textContent = state.before;
          beforeEl.classList.remove("empty");
        } else {
          beforeEl.textContent = "Clipboard is empty.";
          beforeEl.classList.add("empty");
        }

        if (state.after && state.after.length) {
          afterEl.textContent = state.after;
          afterEl.classList.remove("empty");
        } else {
          afterEl.textContent = "No output yet.";
          afterEl.classList.add("empty");
        }

        if (state.diff && state.diff.length) {
          diffEl.textContent = state.diff;
          diffEl.classList.remove("empty");
        } else {
          diffEl.textContent = "No changes.";
          diffEl.classList.add("empty");
        }
        renderConfig();
      }

      function renderHistory() {
        recentList.innerHTML = "";
        if (!state.history || !state.history.length) {
          const empty = document.createElement("div");
          empty.className = "empty-state";
          empty.textContent = "No recent actions yet.";
          recentList.appendChild(empty);
          return;
        }
        state.history.forEach((item) => {
          const card = document.createElement("div");
          card.className = "history-item";
          const title = document.createElement("strong");
          title.textContent = `${item.action} · ${item.rule}`;
          const meta = document.createElement("div");
          meta.textContent = item.time;
          const snippet = document.createElement("div");
          snippet.textContent = item.snippet;
          card.appendChild(title);
          card.appendChild(meta);
          card.appendChild(snippet);
          recentList.appendChild(card);
        });
      }

      window.__SET_STATE__ = (next) => {
        state.suggestions = next.suggestions || [];
        state.allRules = next.all_rules || [];
        state.selectedRuleId = next.selected_rule_id || (state.suggestions[0] && state.suggestions[0].id);
        state.before = next.before || "";
        state.after = next.after || "";
        state.diff = next.diff || "";
        state.activeApp = next.active_app || null;
        state.contentTypes = next.content_types || [];
        state.config = next.config || state.config;
        state.history = next.history || state.history || [];
        state.stats = next.stats || state.stats;
        state.error = next.error || null;
        state.configDraftError = next.config_draft_error || null;
        state.configDiff = next.config_diff || null;
        configDirty = !!(state.configDiff && state.configDiff.trim().length);
        if (!document.activeElement || document.activeElement !== searchInput) {
          searchQuery = (next.search_query || "").toLowerCase();
          searchInput.value = searchQuery;
        }
        state.configText = next.config_text || state.configText;
        state.configError = next.config_error || null;
        render();
      };

      function cycleSelection(delta) {
        const list = visibleRules();
        if (!list.length) return;
        const ids = list.map((rule) => rule.id);
        const current = ids.indexOf(state.selectedRuleId);
        const nextIndex = current === -1 ? 0 : (current + delta + ids.length) % ids.length;
        selectRule(ids[nextIndex]);
      }

      document.getElementById("paste").onclick = () =>
        window.ipc.postMessage(JSON.stringify({ type: "paste" }));
      document.getElementById("copy").onclick = () =>
        window.ipc.postMessage(JSON.stringify({ type: "copy" }));
      document.getElementById("cancel").onclick = () =>
        window.ipc.postMessage(JSON.stringify({ type: "cancel" }));
      document.getElementById("helpBtn").onclick = () => toggleHelpOverlay();
      document.getElementById("helpClose").onclick = () => toggleHelpOverlay();
      document.getElementById("helpOverlay").onclick = (event) => {
        if (event.target === event.currentTarget) toggleHelpOverlay();
      };

      // Config toggle button
      document.getElementById("configToggle").onclick = () => {
        configOpen = !configOpen;
        configDirty = false;
        if (configOpen) {
          window.ipc.postMessage(JSON.stringify({ type: "request_config" }));
        }
        renderConfig();
      };

      // Tab switching
      document.querySelectorAll(".config-tab").forEach(tab => {
        tab.onclick = () => switchConfigTab(tab.dataset.tab);
      });

      // Config close button (X)
      document.getElementById("configCloseX").onclick = () => {
        configOpen = false;
        renderConfig();
      };

      // Backdrop click to close
      configBackdrop.onclick = () => {
        configOpen = false;
        renderConfig();
      };

      document.getElementById("configReload").onclick = () => {
        configDirty = false;
        window.ipc.postMessage(JSON.stringify({ type: "request_config" }));
        showToast("Configuration reloaded");
      };

      configRevertBtn.onclick = () => {
        if (!state.configText) return;
        configDirty = false;
        configText.value = state.configText;
        window.ipc.postMessage(JSON.stringify({ type: "update_config_draft", raw: configText.value }));
        renderConfig();
        showToast("Changes reverted");
      };

      document.getElementById("configClose").onclick = () => {
        configOpen = false;
        renderConfig();
      };

      document.getElementById("configSave").onclick = () => {
        const raw = configText.value;
        window.ipc.postMessage(JSON.stringify({ type: "save_config", raw }));
        showToast("Configuration saved!");
      };

      configText.addEventListener("input", () => {
        configDirty = true;
        if (configDraftTimer) {
          clearTimeout(configDraftTimer);
        }
        configDraftTimer = setTimeout(() => {
          window.ipc.postMessage(JSON.stringify({ type: "update_config_draft", raw: configText.value }));
        }, 150);
      });

      searchInput.addEventListener("input", (event) => {
        searchQuery = event.target.value.toLowerCase();
        renderRules();
        window.ipc.postMessage(JSON.stringify({ type: "update_search", value: searchQuery }));
      });

      window.addEventListener("keydown", (event) => {
        const tag = document.activeElement && document.activeElement.tagName.toLowerCase();
        const inField = tag === "input" || tag === "textarea";
        const inSearch = document.activeElement === searchInput;
        const inConfigText = document.activeElement === configText;

        // Focus search: / or Cmd+K (not in text fields)
        if (!inField && event.key === "/") {
          event.preventDefault();
          searchInput.focus();
          return;
        }

        if (event.metaKey && event.key.toLowerCase() === "k") {
          event.preventDefault();
          searchInput.focus();
          return;
        }

        // Arrow navigation: works everywhere except config text area
        if (!inConfigText && (event.key === "ArrowDown" || event.key === "ArrowUp")) {
          event.preventDefault();
          cycleSelection(event.key === "ArrowDown" ? 1 : -1);
          return;
        }

        // Tab cycling through rules (not in config text)
        if (!inConfigText && event.key === "Tab" && !event.metaKey && !event.ctrlKey) {
          event.preventDefault();
          cycleSelection(event.shiftKey ? -1 : 1);
          return;
        }

        // Number keys 1-9 for quick rule selection (not in text fields)
        if (!inField && event.key >= "1" && event.key <= "9" && !event.metaKey && !event.ctrlKey && !event.altKey) {
          const index = parseInt(event.key) - 1;
          const list = visibleRules();
          if (index < list.length) {
            event.preventDefault();
            selectRule(list[index].id);
          }
          return;
        }

        // Enter in search: select the first result and paste
        if (inSearch && event.key === "Enter" && !event.metaKey) {
          event.preventDefault();
          const list = visibleRules();
          if (list.length > 0) {
            selectRule(list[0].id);
            // Small delay to let state update, then paste
            setTimeout(() => {
              window.ipc.postMessage(JSON.stringify({ type: "paste" }));
            }, 50);
          }
          return;
        }

        // Cmd+P to toggle pin on selected rule (not in text fields)
        if (!inField && event.metaKey && event.key.toLowerCase() === "p") {
          event.preventDefault();
          const selected = state.allRules.find((rule) => rule.id === state.selectedRuleId);
          if (selected) {
            window.ipc.postMessage(
              JSON.stringify({ type: "toggle_pinned", id: selected.id, value: !selected.pinned })
            );
          }
          return;
        }

        // ? to show help overlay (not in text fields)
        if (!inField && event.key === "?" && !event.metaKey) {
          event.preventDefault();
          toggleHelpOverlay();
          return;
        }

        if (event.key === "Escape") {
          event.preventDefault();
          // Close help overlay first
          if (helpOverlayVisible) {
            toggleHelpOverlay();
            return;
          }
          if (configOpen) {
            configOpen = false;
            renderConfig();
            return;
          }
          if (searchQuery) {
            searchQuery = "";
            searchInput.value = "";
            searchInput.blur();
            renderRules();
            window.ipc.postMessage(JSON.stringify({ type: "update_search", value: "" }));
            return;
          }
          window.ipc.postMessage(JSON.stringify({ type: "cancel" }));
        }

        if (event.metaKey && event.key === "Enter") {
          event.preventDefault();
          window.ipc.postMessage(JSON.stringify({ type: "paste" }));
        }
        // Cmd+Shift+C for copy (Cmd+C alone is reserved for system clipboard)
        if (event.metaKey && event.shiftKey && event.key.toLowerCase() === "c") {
          event.preventDefault();
          window.ipc.postMessage(JSON.stringify({ type: "copy" }));
        }
      });

    </script>
  </body>
</html>
